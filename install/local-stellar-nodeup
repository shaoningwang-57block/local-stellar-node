#!/usr/bin/env bash
set -euo pipefail

# ✅ 一定要是你的 repo
REPO="${REPO:-shaoningwang-57block/local-stellar-node}"

# 可选：指定版本，比如 v0.1.0；不指定则装 latest
VERSION="${VERSION:-latest}"

INSTALL_DIR="${INSTALL_DIR:-$HOME/.local-stellar-node}"
BIN_DIR="${BIN_DIR:-$HOME/.local/bin}"
BIN_NAME="stellar-tool"

# --- helpers ---
log() { echo "[local-stellar-nodeup] $*"; }
die() { echo "[local-stellar-nodeup] ERROR: $*" >&2; exit 1; }

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "missing required command: $1"
}

detect_platform() {
  local os arch
  os="$(uname -s)"
  arch="$(uname -m)"

  case "$os" in
    Darwin) os="darwin" ;;
    Linux)  os="linux" ;;
    *) die "unsupported OS: $os" ;;
  esac

  case "$arch" in
    x86_64|amd64) arch="x86_64" ;;
    arm64|aarch64) arch="aarch64" ;;
    *) die "unsupported arch: $arch" ;;
  esac

  echo "${os}_${arch}"
}

ensure_path() {
  mkdir -p "$BIN_DIR"

  if ! echo ":$PATH:" | grep -q ":$BIN_DIR:"; then
    log "NOTE: $BIN_DIR is not in your PATH."
    log "Add this line to your shell profile (e.g. ~/.zshrc or ~/.bashrc):"
    echo "    export PATH=\"$BIN_DIR:\$PATH\""
  fi
}

release_url() {
  local platform="$1"

  # 产物名：local-stellar-node_<os>_<arch>.tar.gz
  # 例：local-stellar-node_darwin_aarch64.tar.gz
  local asset="local-stellar-node_${platform}.tar.gz"

  if [[ "$VERSION" == "latest" ]]; then
    echo "https://github.com/${REPO}/releases/latest/download/${asset}"
  else
    # 指定 tag，比如 VERSION=v0.1.0
    echo "https://github.com/${REPO}/releases/download/${VERSION}/${asset}"
  fi
}

install_release() {
  local platform="$1"
  local url
  url="$(release_url "$platform")"

  log "installing platform=$platform"
  log "download: $url"

  rm -rf "$INSTALL_DIR"
  mkdir -p "$INSTALL_DIR"

  local tmp
  tmp="$(mktemp -d)"
  # 注意：这里不要用 EXIT 覆盖外层的 trap，所以用 RETURN
  trap 'rm -rf "$tmp"' RETURN

  # ✅ 下载（失败直接退出）
  curl -fL "$url" -o "$tmp/pkg.tar.gz"

  # ✅ 判断是不是 gzip（避免 tar 解 HTML）
  if ! file "$tmp/pkg.tar.gz" | grep -qi 'gzip'; then
    log "downloaded file is not a gzip archive:"
    file "$tmp/pkg.tar.gz" || true
    log "first 5 lines of downloaded content:"
    head -n 5 "$tmp/pkg.tar.gz" || true
    die "bad release asset (likely 404 or wrong repo/tag/asset name)"
  fi

  # 解压
  tar -xzf "$tmp/pkg.tar.gz" -C "$INSTALL_DIR"

  # 建软链
  mkdir -p "$BIN_DIR"
  chmod +x "$INSTALL_DIR/bin/$BIN_NAME" || true
  ln -sf "$INSTALL_DIR/bin/$BIN_NAME" "$BIN_DIR/$BIN_NAME"

  log "installed: $BIN_DIR/$BIN_NAME -> $INSTALL_DIR/bin/$BIN_NAME"
}

main() {
  need_cmd curl
  need_cmd tar
  need_cmd file

  local platform
  platform="$(detect_platform)"

  ensure_path
  install_release "$platform"

  log "done ✅"
  log "try:"
  echo "    $BIN_NAME start"
}

main "$@"