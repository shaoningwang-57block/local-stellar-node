#!/usr/bin/env bash
set -euo pipefail

REPO="${REPO:-shaoningwang-57block/local-stellar-node}"   # 你的 github repo
INSTALL_DIR="${INSTALL_DIR:-$HOME/.local-stellar-node}"
BIN_DIR="${BIN_DIR:-$HOME/.local/bin}"
BIN_NAME="stellar-tool"

# --- helpers ---
log() { echo "[local-stellar-nodeup] $*"; }
die() { echo "[local-stellar-nodeup] ERROR: $*" >&2; exit 1; }

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "missing required command: $1"
}

detect_platform() {
  local os arch
  os="$(uname -s)"
  arch="$(uname -m)"

  case "$os" in
    Darwin) os="darwin" ;;
    Linux)  os="linux" ;;
    *) die "unsupported OS: $os" ;;
  esac

  case "$arch" in
    x86_64|amd64) arch="x86_64" ;;
    arm64|aarch64) arch="aarch64" ;;
    *) die "unsupported arch: $arch" ;;
  esac

  echo "${os}_${arch}"
}

ensure_path() {
  mkdir -p "$BIN_DIR"

  if ! echo ":$PATH:" | grep -q ":$BIN_DIR:"; then
    log "NOTE: $BIN_DIR is not in your PATH."
    log "Add this line to your shell profile (e.g. ~/.zshrc or ~/.bashrc):"
    echo "    export PATH=\"$BIN_DIR:\$PATH\""
  fi
}

fetch_latest_release_url() {
  local platform="$1"
  # 你的 release 产物命名：
  # local-stellar-node_darwin_aarch64.tar.gz
  echo "https://github.com/$REPO/releases/latest/download/local-stellar-node_${platform}.tar.gz"
}

install_release() {
  local platform="$1"
  local url
  url="$(fetch_latest_release_url "$platform")"

  log "installing platform=$platform"
  log "download: $url"

  rm -rf "$INSTALL_DIR"
  mkdir -p "$INSTALL_DIR"

  local tmp
  tmp="$(mktemp -d)"

  # 下载并解压
  curl -L "$url" -o "$tmp/pkg.tar.gz"

  # 简单校验一下是不是 gzip（避免下载到 HTML 404 页）
  if ! file "$tmp/pkg.tar.gz" | grep -qi "gzip"; then
    echo "---- downloaded file type ----"
    file "$tmp/pkg.tar.gz" || true
    echo "---- first 20 bytes ----"
    head -c 200 "$tmp/pkg.tar.gz" || true
    die "downloaded file is not a valid .tar.gz (maybe release asset not found?)"
  fi

  tar -xzf "$tmp/pkg.tar.gz" -C "$INSTALL_DIR"

  # 清理临时目录（不要用 EXIT trap + local 变量）
  rm -rf "$tmp"

  # 创建软链到 ~/.local/bin
  mkdir -p "$BIN_DIR"
  ln -sf "$INSTALL_DIR/bin/$BIN_NAME" "$BIN_DIR/$BIN_NAME"
  chmod +x "$INSTALL_DIR/bin/$BIN_NAME"

  log "installed: $BIN_DIR/$BIN_NAME -> $INSTALL_DIR/bin/$BIN_NAME"
}

main() {
  need_cmd curl
  need_cmd tar
  need_cmd file

  local platform
  platform="$(detect_platform)"

  ensure_path
  install_release "$platform"

  log "done ✅"
  log "try:"
  echo "    $BIN_NAME start"
}

main "$@"